{"version":3,"sources":["GameScene.js"],"names":["cc","Class","extends","Component","properties","ballPanel","Node","smallBallPF","Prefab","bigBall","levelLabel","Label","bulletNode","bgNode","init","params","smallBalls","tmpBalls","_bigSpeed","_bigDir","_gameStart","curLevel","zy","dataMng","userData","parseInt","loadLevel","l","data","levelData","getLevelData","dir","Math","random","speed","string","b","destroy","splice","i","smallNum","ball","instantiate","parent","push","getComponentInChildren","color","loadBigBall","bigNum","scheduleOnce","start","mng","director","getCollisionManager","enabled","node","on","EventType","TOUCH_START","onTouchStart","event","ui","tip","show","counts","destroyAllChildren","radius","width","degree","radian","misc","degreesToRadians","x","sin","y","cos","angle","getChildByName","active","length","bullet","shift","wordPos","convertToWorldSpaceAR","getPosition","position","convertToNodeSpaceAR","height","des","v2","runAction","sequence","moveTo","easing","easeSineOut","callFunc","_checkPass","max","getMaxLevel","lateUpdate","dt"],"mappings":"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","file":"GameScene.js","sourceRoot":"../../../../../assets/scripts/scene","sourcesContent":["/**\n * Created by xujiawei on 2020-04-29 17:37:50\n */\n\ncc.Class({\n    extends: cc.Component,\n    properties: {\n        ballPanel: cc.Node,\n        smallBallPF: cc.Prefab,\n        bigBall: cc.Node,\n        levelLabel: cc.Label,\n        bulletNode: cc.Node,\n        bgNode: cc.Node,\n    },\n\n    init(params) {\n        this.smallBalls = [];\n        this.tmpBalls = []; // 发射的尚未添加到大球上的小球\n        this._bigSpeed = 0;\n        this._bigDir = -1;\n        this._gameStart = false;\n        this.curLevel = zy.dataMng.userData.curLevel;\n        this.curLevel = parseInt(this.curLevel);\n        this.loadLevel(this.curLevel);\n    },\n\n    loadLevel(l) {\n        let data = zy.dataMng.levelData.getLevelData(l);\n        this._bigDir = data.dir == 0 ? (Math.random() < 0.5 ? 1 : -1) : data.dir;\n        this._bigSpeed = data.speed;\n        this.levelLabel.string = \"第 \" + l + \" 关\";\n\n        // 清空数据\n        for (let b of this.tmpBalls) {\n            b.destroy();\n        }\n        for (let b of this.smallBalls) {\n            b.destroy();\n        }\n        this.tmpBalls.splice(0);\n        this.smallBalls.splice(0);\n\n        for (let i = 0; i < data.smallNum; i++) {\n            let ball = cc.instantiate(this.bulletNode);\n            ball.parent = this.ballPanel;\n            this.smallBalls.push(ball);\n            ball.getComponentInChildren(cc.Label).string = data.smallNum - i;\n        }\n\n        this.bgNode.color = cc.color(\"#436770\");\n        this.loadBigBall(data.bigNum);\n\n        this.scheduleOnce(() => {\n            this._gameStart = true;\n        }, 0.1);\n    },\n\n    start() {\n        let mng = cc.director.getCollisionManager();\n        mng.enabled = true;\n        // mng.enabledDebugDraw = true;\n        // mng.enabledDrawBoundingBox = true;\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        zy.event.on(\"gameover\", () => {\n            if (this._gameStart) {\n                this._gameStart = false;\n                this.bgNode.color = cc.color(\"#7A3341\");\n                zy.ui.tip.show(\"游戏失败，即将重新开始\");\n                this.scheduleOnce(() => {\n                    this.loadLevel(this.curLevel);\n                }, 2);\n            }\n        }, this);\n    },\n\n    loadBigBall(counts) {\n        this.bigBall.destroyAllChildren();\n        let radius = this.bigBall.width / 2 - 2;\n        let degree = 360 / counts;\n        for (let i = 0; i < counts; i++) {\n            let ball = cc.instantiate(this.smallBallPF);\n            let radian = cc.misc.degreesToRadians(i * degree);\n            let x = radius * Math.sin(radian);\n            let y = radius * Math.cos(radian);\n            ball.x = x;\n            ball.y = y;\n            ball.parent = this.bigBall;\n            // 计算旋转角度\n            ball.angle = 180 - i * degree;\n            ball.getChildByName(\"numLabel\").active = false;\n        }\n    },\n\n    onTouchStart(event) {\n        if (!this._gameStart) {\n            return;\n        }\n\n        if (this.smallBalls.length > 0) {\n            let bullet = this.smallBalls.shift();\n            let wordPos = bullet.parent.convertToWorldSpaceAR(bullet.getPosition());\n\n            let ball = cc.instantiate(this.smallBallPF);\n            ball.getComponentInChildren(cc.Label).string = bullet.getComponentInChildren(cc.Label).string;\n            ball.parent = this.bigBall.parent;\n            ball.position = this.bigBall.parent.convertToNodeSpaceAR(wordPos);\n            this.tmpBalls.push(ball);\n            bullet.destroy();\n\n            let radius = this.bigBall.height / 2 - 2;\n            let des = cc.v2(0, this.bigBall.y - radius);\n            ball.runAction(cc.sequence(cc.moveTo(0.1, des).easing(cc.easeSineOut()), cc.callFunc(() => {\n                this.tmpBalls.shift();\n                ball.parent = this.bigBall;\n                let angle = this.bigBall.angle;\n                angle = angle % 360 + 180;\n                let radian = cc.misc.degreesToRadians(angle);\n\n                let x = radius * Math.sin(radian);\n                let y = radius * Math.cos(radian);\n                ball.x = x;\n                ball.y = y;\n                ball.angle = 180 - angle;\n\n                this._checkPass();\n            })));\n        }\n    },\n\n    _checkPass() {\n        if (this.smallBalls.length == 0) {\n            this._gameStart = false;\n            this.bgNode.color = cc.color(\"#4C7043\");\n            let des = \"恭喜过关，即将进入下一关\";\n            const max = zy.dataMng.levelData.getMaxLevel();\n            if (this.curLevel < max) {\n                this.curLevel += 1;\n            } else {\n                des = \"恭喜你通关了\";\n            }\n            zy.ui.tip.show(des);\n            this.scheduleOnce(() => {\n                this.loadLevel(this.curLevel);\n            }, 2);\n\n            zy.dataMng.userData.curLevel = this.curLevel;\n        }\n        \n    },\n\n    lateUpdate(dt) {\n        if (!this._gameStart) {\n            return;\n        }\n        this.bigBall.angle += this._bigDir * this._bigSpeed;\n    }\n});"]}