{"version":3,"sources":["HotUpdate.js"],"names":["UpdatePanel","require","cc","Class","extends","Component","properties","panel","manifestUrl","type","Asset","default","versionUrl","updateUI","Node","_updating","_canRetry","_storagePath","checkCb","event","log","getEventCode","hasNew","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","director","loadScene","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","fileProgress","progress","byteProgress","_am","setEventCallback","_checkListener","show","updateCb","needRestart","failed","info","string","UPDATE_PROGRESSION","getPercent","getPercentByFile","fileLabel","getDownloadedFiles","getTotalFiles","byteLabel","getDownloadedBytes","getTotalBytes","msg","getMessage","UPDATE_FINISHED","UPDATE_FAILED","retryBtn","active","ERROR_UPDATING","getAssetId","ERROR_DECOMPRESS","_updateListener","searchPaths","fileUtils","getSearchPaths","newPaths","getLocalManifest","console","JSON","stringify","Array","prototype","unshift","apply","sys","localStorage","setItem","setSearchPaths","audioEngine","stopAll","game","restart","loadCustomManifest","getState","AssetsManager","State","UNINITED","manifest","Manifest","customManifestStr","loadLocalManifest","retry","downloadFailedAssets","checkUpdate","url","nativeUrl","loader","md5Pipe","transformURL","isLoaded","bind","hotUpdate","_failCount","update","onLoad","isNative","getWritablePath","HOT_UPDATE_SUB_PATH","versionCompareHandle","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","os","OS_ANDROID","setMaxConcurrentTask","start","PlatformUtils","rmSplash","onDestroy"],"mappings":"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","file":"HotUpdate.js","sourceRoot":"../../../../../assets/scripts/hotUpdate","sourcesContent":["let UpdatePanel = require(\"./UpdatePanel\");\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        panel: UpdatePanel,\n        manifestUrl: {\n            type: cc.Asset,\n            default: null\n        },\n        versionUrl: {\n            type: cc.Asset,\n            default: null\n        },\n\n        updateUI: cc.Node,\n        _updating: false,\n        _canRetry: false,\n        _storagePath: ''\n    },\n\n    checkCb: function (event) {\n        cc.log('Code: ' + event.getEventCode());\n        let hasNew = false;\n        switch (event.getEventCode())\n        {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                // this.panel.info.string = \"No local manifest file found, hot update skipped.\";\n                cc.log(\"No local manifest file found, hot update skipped.\");\n                cc.director.loadScene(\"InitScene\");\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                // this.panel.info.string = \"Fail to download manifest file, hot update skipped.\";\n                cc.log(\"Fail to download manifest file, hot update skipped.\");\n                cc.director.loadScene(\"InitScene\");\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                // this.panel.info.string = \"Already up to date with the latest remote version.\";\n                cc.log(\"Already up to date with the latest remote version.\");\n                cc.director.loadScene(\"InitScene\");\n                break;\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\n                // this.panel.info.string = 'New version found, please try to update.';\n                this.panel.fileProgress.progress = 0;\n                this.panel.byteProgress.progress = 0;\n                hasNew = true;\n                break;\n            default:\n                return;\n        }\n\n        this._am.setEventCallback(null);\n        // this._updateListener = new jsb.EventListenerAssetsManager(this._am,null);\n        // cc.eventManager.addListener(this._updateListener, 1);\n\n        this._checkListener = null;\n        this._updating = false;\n\n        if (hasNew) {\n            this.show();\n        }\n    },\n\n    updateCb: function (event) {\n        let needRestart = false;\n        let failed = false;\n        switch (event.getEventCode())\n        {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                this.panel.info.string = 'No local manifest file found, hot update skipped.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\n                this.panel.byteProgress.progress = event.getPercent();\n                this.panel.fileProgress.progress = event.getPercentByFile();\n\n                this.panel.fileLabel.string = event.getDownloadedFiles() + ' / ' + event.getTotalFiles();\n                this.panel.byteLabel.string = event.getDownloadedBytes() + ' / ' + event.getTotalBytes();\n\n                let msg = event.getMessage();\n                if (msg) {\n                    this.panel.info.string = 'Updated file: ' + msg;\n                    // cc.log(event.getPercent()/100 + '% : ' + msg);\n                }\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                this.panel.info.string = 'Fail to download manifest file, hot update skipped.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                this.panel.info.string = 'Already up to date with the latest remote version.';\n                failed = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\n                this.panel.info.string = 'Update finished. ' + event.getMessage();\n                needRestart = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FAILED:\n                this.panel.info.string = 'Update failed. ' + event.getMessage();\n                this.panel.retryBtn.active = true;\n                this._updating = false;\n                this._canRetry = true;\n                break;\n            case jsb.EventAssetsManager.ERROR_UPDATING:\n                this.panel.info.string = 'Asset update error: ' + event.getAssetId() + ', ' + event.getMessage();\n                break;\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\n                this.panel.info.string = event.getMessage();\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            this._am.setEventCallback(null);\n            // this._updateListener = new jsb.EventListenerAssetsManager(this._am,null);\n            // cc.eventManager.addListener(this._updateListener, 1);\n\n            this._updateListener = null;\n            this._updating = false;\n        }\n\n        if (needRestart) {\n            this._am.setEventCallback(null);\n            // this._updateListener = new jsb.EventListenerAssetsManager(this._am,null);\n            // cc.eventManager.addListener(this._updateListener, 1);\n\n            this._updateListener = null;\n            // Prepend the manifest's search path\n            let searchPaths = jsb.fileUtils.getSearchPaths();\n            let newPaths = this._am.getLocalManifest().getSearchPaths();\n            console.log(JSON.stringify(newPaths));\n            Array.prototype.unshift.apply(searchPaths, newPaths);\n            // This value will be retrieved and appended to the default search path during game startup,\n            // please refer to samples/js-tests/main.js for detailed usage.\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\n            cc.log(\"seachPaths: \"+ JSON.stringify(searchPaths));\n            jsb.fileUtils.setSearchPaths(searchPaths);\n\n            cc.audioEngine.stopAll();\n            cc.game.restart();\n        }\n    },\n\n    loadCustomManifest: function () {\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n            let manifest = new jsb.Manifest(customManifestStr, this._storagePath);\n            this._am.loadLocalManifest(manifest, this._storagePath);\n            this.panel.info.string = 'Using custom manifest';\n        }\n    },\n\n    retry: function () {\n        if (!this._updating && this._canRetry) {\n            this.panel.retryBtn.active = false;\n            this._canRetry = false;\n\n            this.panel.info.string = 'Retry failed Assets...';\n            this._am.downloadFailedAssets();\n        }\n    },\n\n    checkUpdate: function () {\n        if (this._updating) {\n            this.panel.info.string = 'Checking or updating ...';\n            return;\n        }\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n            // Resolve md5 url\n            let url = this.manifestUrl.nativeUrl;\n            if (cc.loader.md5Pipe) {\n                url = cc.loader.md5Pipe.transformURL(url);\n            }\n            this._am.loadLocalManifest(url);\n        }\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\n            this.panel.info.string = 'Failed to load local manifest ...';\n            return;\n        }\n        // 2.x版本直接使用assetManager.setEventCallback\n        this._am.setEventCallback(this.checkCb.bind(this));\n        // 这里有问题，2.x以下版本无法使用\n        // this.updateListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\n        // cc.eventManager.addListener(this.updateListener, 1);\n\n        this._am.checkUpdate();\n        this._updating = true;\n    },\n\n    hotUpdate: function () {\n        cc.log(\"111111\");\n        cc.log(this._am);\n        cc.log(this._updating);\n        if (this._am && !this._updating) {\n            this._am.setEventCallback(this.updateCb.bind(this));\n            // this.updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\n            // cc.eventManager.addListener(this.updateListener, 1);\n            cc.log(\"2222222\");\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\n                // Resolve md5 url\n                let url = this.manifestUrl.nativeUrl;\n                if (cc.loader.md5Pipe) {\n                    url = cc.loader.md5Pipe.transformURL(url);\n                }\n                this._am.loadLocalManifest(url);\n                cc.log(\"33333\");\n            }\n            cc.log(\"4444\");\n            this._failCount = 0;\n            this._am.update();\n            this._updating = true;\n        }\n    },\n\n    show: function () {\n        if (this.updateUI.active == false) {\n            this.updateUI.active = true;\n            this.hotUpdate();\n        }\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        // Hot update is only available in Native build\n        if (!cc.sys.isNative) {\n            return;\n        }\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + HOT_UPDATE_SUB_PATH);\n        cc.log('Storage path for remote asset : ' + this._storagePath);\n\n        // Setup your own version compare handler, versionA and B is versions in string\n        // if the return value greater than 0, versionA is greater than B,\n        // if the return value equals 0, versionA equals to B,\n        // if the return value smaller than 0, versionA is smaller than B.\n        this.versionCompareHandle = function (versionA, versionB) {\n            cc.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\n            let vA = versionA.split('.');\n            let vB = versionB.split('.');\n            for (let i = 0; i < vA.length; ++i) {\n                let a = parseInt(vA[i]);\n                let b = parseInt(vB[i] || 0);\n                if (a === b) {\n                    continue;\n                }\n                else {\n                    return a - b;\n                }\n            }\n            if (vB.length > vA.length) {\n                return -1;\n            }\n            else {\n                return 0;\n            }\n        };\n\n        // Init with empty manifest url for testing custom manifest\n        this._am = new jsb.AssetsManager('', this._storagePath, this.versionCompareHandle);\n\n        let panel = this.panel;\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\n        // Return true if the verification passed, otherwise return false\n        this._am.setVerifyCallback(function (path, asset) {\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\n            let compressed = asset.compressed;\n            // Retrieve the correct md5 value.\n            let expectedMD5 = asset.md5;\n            // asset.path is relative path and path is absolute.\n            let relativePath = asset.path;\n            // The size of asset file, but this value could be absent.\n            let size = asset.size;\n            if (compressed) {\n                panel.info.string = \"Verification passed : \" + relativePath;\n                return true;\n            }\n            else {\n                panel.info.string = \"Verification passed : \" + relativePath + ' (' + expectedMD5 + ')';\n                return true;\n            }\n        });\n\n        // this.panel.info.string = 'Hot update is ready, please check or directly update.';\n        cc.log(\"Hot update is ready, please check or directly update.\");\n\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\n            // Some Android device may slow down the download process when concurrent tasks is too much.\n            // The value may not be accurate, please do more test and find what's most suitable for your game.\n            this._am.setMaxConcurrentTask(2);\n            // this.panel.info.string = \"Max concurrent tasks count have been limited to 2\";\n            cc.log(\"android: Max concurrent tasks count have been limited to 2\");\n        }\n\n        this.panel.fileProgress.progress = 0;\n        this.panel.byteProgress.progress = 0;\n    },\n\n    start(){\n        if (!cc.sys.isNative) {\n            cc.director.loadScene(\"InitScene\");\n            return;\n        }\n        this.checkUpdate();\n\n        const PlatformUtils = require(\"./../framework/platform/PlatformUtils\");\n        PlatformUtils.rmSplash();\n    },\n\n    onDestroy: function () {\n        if (this._updateListener) {\n            this._am.setEventCallback(null);\n            // this._updateListener = new jsb.EventListenerAssetsManager(this._am,null);\n            // cc.eventManager.addListener(this._updateListener, 1);\n\n            this._updateListener = null;\n        }\n    }\n});\n"]}