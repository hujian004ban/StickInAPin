{"version":3,"sources":["../../../../../../../assets/scripts/framework/net/socket/assets/scripts/framework/net/socket/GameNetwork.js"],"names":["GameWebSocket","require","GameProtocols","response_state","ERROR_OK","NetworkCallback","cc","Class","properties","request","callback","init","GameNetwork","extends","GameWebSocketDelegate","ctor","_socket","_delegate","_requestSequenceId","pushResponseCallback","_networkCallbacks","setDelegate","delegate","registerPushResponseCallback","act","isSocketOpened","getState","GameWebSocketState","OPEN","isSocketClosed","connect","url","log","closeConnect","close","onSocketOpen","onNetworkOpen","onSocketError","onSocketClosed","reason","onNetworkClose","onSocketMessage","msg","_onResponse","responseData","responseJson","JSON","parse","responseClass","response_classes","response","loadData","data","seq","err","ts","ignoreError","pushCallback","callbackObj","is_async","sendRequest","opt_callback","_sendSocketRequest","sendRequestNoData","isNoData","req","assert","stringify","send","module","exports"],"mappings":"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","file":"GameNetwork.js","sourceRoot":"../../../../../../../assets/scripts/framework/net/socket","sourcesContent":["/**\n * Created by skyxu on 2018/10/9.\n */\n\n\"use strict\";\n\nlet GameWebSocket = require(\"./GameWebSocket\");\nlet GameProtocols = require(\"./GameProtocols\");\n\n/**\n * 服务器回复消息状态，判断回复消息的各种问题\n */\nvar response_state = {\n    ERROR_OK : '0'\n};\n\n/**\n * 请求回调对象，收到服务器回调后的回调方法\n */\nvar NetworkCallback = cc.Class({\n\n    properties: {\n\n        /**\n         * @type {BaseRequest} request\n         */\n        request: null,\n\n        /**\n         * 请求回调对方法\n         */\n        callback: null\n    },\n\n    /**\n     * @param {BaseRequest} request\n     * @param {function(BaseResponse): boolean} callback\n     */\n    init: function (request, callback) {\n        this.request = request;\n        this.callback = callback;\n    }\n});\n\n\nlet GameNetwork = cc.Class({\n    extends: GameWebSocket.GameWebSocketDelegate,\n\n    ctor: function() {\n        this._socket = null;\n\n        this._delegate = null;\n\n        /**\n         * 每次发送请求，都需要有一个唯一的编号\n         * @type {number}\n         * @private\n         */\n        this._requestSequenceId = 0;\n\n        /**\n         * 接受服务器主动下发的response回调\n         * key 表示BaseResponse.act\n         * @type {Object.<string, function(object.<string, *>)>}\n         */\n        this.pushResponseCallback = {};\n\n        /**\n         * 根据seq保存Request和其callback，以便在收到服务器的响应后回调\n         * @type {Object.<int, NetworkCallback>}\n         * @private\n         */\n        this._networkCallbacks = {};\n    },\n\n    setDelegate: function (delegate) {\n        this._delegate = delegate;\n    },\n\n    /**\n     * 注册服务器主动推送的response 回调\n     */\n    registerPushResponseCallback : function(act, callback){\n        this.pushResponseCallback[act] = callback;\n    },\n\n    /**\n     * 判断socket已连接成功，可以通信\n     * @returns {boolean}\n     */\n    isSocketOpened: function(){\n        return (this._socket && this._socket.getState() == GameWebSocket.GameWebSocketState.OPEN);\n    },\n\n    isSocketClosed: function () {\n        return this._socket == null;\n    },\n\n    /**\n     * 启动连接\n     */\n    connect: function (url) {\n        cc.log(\"webSocketUrls=\" + url);\n        this._requestSequenceId = 0;\n        this._socket = new GameWebSocket.GameWebSocket();\n        this._socket.init(url, this);\n        this._socket.connect();\n    },\n\n    closeConnect: function () {\n        if(this._socket){\n            this._socket.close();\n        }\n    },\n\n    onSocketOpen: function () {\n        cc.log('Socket:onOpen');\n        if(this._delegate && this._delegate.onNetworkOpen){\n            this._delegate.onNetworkOpen();\n        }\n    },\n\n    onSocketError: function () {\n        cc.log('Socket:onError');\n    },\n\n    onSocketClosed: function (reason) {\n        cc.log('Socket:onClose', reason);\n        if (this._socket) {\n            this._socket.close();\n        }\n        this._socket = null;\n\n        if(this._delegate && this._delegate.onNetworkClose){\n            this._delegate.onNetworkClose();\n        }\n    },\n\n    onSocketMessage: function (msg) {\n        this._onResponse(msg);\n    },\n\n    _onResponse: function(responseData){\n        cc.log('response->resp:', responseData);\n        var responseJson = JSON.parse(responseData);\n        var responseClass = GameProtocols.response_classes[responseJson.act];\n        /**\n         * @type {object.<BaseResponse>}\n         */\n        var response = new responseClass();\n        response.loadData(responseJson.data);\n        response.act = responseJson.act;\n        response.seq = responseJson.seq;\n        response.err = responseJson.err;\n        response.ts = responseJson.ts;\n\n        // 如果指定了回调函数，先回调\n        var ignoreError = false;\n        if(response.seq != -1){\n            // 处理服务器推送消息\n            var pushCallback = this.pushResponseCallback[response.act];\n            if(pushCallback){\n                pushCallback(response);\n            }\n\n            // request回调\n            var callbackObj = this._networkCallbacks[response.seq];\n            if(callbackObj){\n                ignoreError = callbackObj.callback(response);\n                // try {\n                //     ignoreError = callbackObj.callback(response);\n                // } catch (err) {\n                //     cc.log(err + \" error in response callback of \" + response.act);\n                // } finally {\n                //     delete this._networkCallbacks[response.seq];\n                // }\n            }\n        }\n\n        //有错，且不忽略，则统一处理错误\n        if(response.err && response.err != response_state.ERROR_OK && !ignoreError){\n            if (response.is_async) {  // 异步请求，如果出错了，应该需要重新登录\n                // todo 重新登录？或者重新同步数据？\n            } else {  // 同步请求，如果出错了，需要显示错误信息\n                // todo 显示错误\n                var msg = responseJson.msg;\n                cc.log('server err ' + msg);\n            }\n        }\n    },\n\n    /**\n     * 向服务器发送请求。\n     *\n     * 如果提供了callback，在收到response后会被回调。如果response是一个错误(status!=ERR_OK)，则需要决定由谁来负责处理错误。\n     * 如果callback中已经对错误进行了处理，应该返回true，这样会忽略该错误。否则应该返回false，则负责处理该错误。\n     *\n     * 特别注意：如果这是一个异步(is_async)请求，且出错，一般来讲应该重新登录/同步。但是如果callback返回了true，不会进行\n     * 任何处理，也就是不会重新登录/同步。请小心确定返回值。\n     *\n     * @param {object.<BaseRequest>}\n     * @param {function(BaseResponse): boolean=} opt_callback 回调函数。出错的情况下，如果返回true，则不会再次处理错误。\n     */\n    sendRequest: function (request, opt_callback) {\n        // 每个请求的seq应该唯一，且递增\n        request.seq = ++this._requestSequenceId;\n\n        //生成NetworkCallback对象，绑定请求seq和回调方法\n        if(opt_callback){\n            this._networkCallbacks[request.seq] = new NetworkCallback();\n            this._networkCallbacks[request.seq].init(request, opt_callback);\n        }\n        this._sendSocketRequest(false, request);\n    },\n\n    /**\n     * sendRequest的不发送data字段\n     */\n    sendRequestNoData: function (request, opt_callback) {\n        // 每个请求的seq应该唯一，且递增\n        request.seq = ++this._requestSequenceId;\n\n        //生成NetworkCallback对象，绑定请求seq和回调方法\n        if(opt_callback){\n            this._networkCallbacks[request.seq] = new NetworkCallback();\n            this._networkCallbacks[request.seq].init(request, opt_callback);\n        }\n        this._sendSocketRequest(true, request);\n    },\n\n    /**\n     * @param {Boolean} isNoData\n     * @param {object.<BaseRequest>} req\n     */\n    _sendSocketRequest: function (isNoData, req) {\n        cc.assert(this._socket);\n\n        if (this.isSocketOpened()){\n            //通过json的方法生成请求字符串\n            var msg = null;\n            if(isNoData){\n                msg = JSON.stringify({seq:req.seq, act:req.act});\n            }else{\n                msg = JSON.stringify({seq:req.seq, act:req.act, data:req});\n            }\n            cc.log(\"WebSocketDelegate::send->\" + msg);\n            this._socket.send(msg);\n        } else{\n            // todo\n        }\n    }\n});\n\nmodule.exports = GameNetwork;"]}