{"version":3,"sources":["../../../../../assets/scripts/scene/assets/scripts/scene/GameScene.js"],"names":["cc","Class","extends","Component","properties","ballPanel","Node","smallBallPF","Prefab","bigBall","levelLabel","Label","bulletNode","bgNode","init","params","smallBalls","tmpBalls","_bigSpeed","_bigDir","_gameStart","curLevel","sys","localStorage","getItem","parseInt","loadLevel","l","data","big","small","speed","dir","string","b","destroy","splice","i","ball","instantiate","parent","push","getComponentInChildren","color","loadBigBall","scheduleOnce","start","mng","director","getCollisionManager","enabled","node","on","EventType","TOUCH_START","onTouchStart","zy","event","ui","tip","show","counts","destroyAllChildren","radius","width","degree","radian","misc","degreesToRadians","x","Math","sin","y","cos","angle","getChildByName","active","length","bullet","shift","wordPos","convertToWorldSpaceAR","getPosition","position","convertToNodeSpaceAR","height","des","v2","runAction","sequence","moveTo","callFunc","_checkPass","max","setItem","lateUpdate","dt"],"mappings":"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","file":"GameScene.js","sourceRoot":"../../../../../assets/scripts/scene","sourcesContent":["/**\n * Created by xujiawei on 2020-04-29 17:37:50\n */\n\ncc.Class({\n    extends: cc.Component,\n    properties: {\n        ballPanel: cc.Node,\n        smallBallPF: cc.Prefab,\n        bigBall: cc.Node,\n        levelLabel: cc.Label,\n        bulletNode: cc.Node,\n        bgNode: cc.Node,\n    },\n\n    init(params) {\n        this.smallBalls = [];\n        this.tmpBalls = []; // 发射的尚未添加到大球上的小球\n        this._bigSpeed = 0;\n        this._bigDir = -1;\n        this._gameStart = false;\n        this.curLevel = cc.sys.localStorage.getItem(\"game_level\") || 1;\n        this.curLevel = parseInt(this.curLevel);\n        this.loadLevel(this.curLevel);\n    },\n\n    loadLevel(l) {\n        let data = {\n            big: 3,\n            small: 5,\n            speed: 1,\n            dir: 1,\n        }\n        this._bigDir = data.dir;\n        this._bigSpeed = data.speed;\n        this.levelLabel.string = \"第 \" + l + \" 关\";\n\n        // 清空数据\n        for (let b of this.tmpBalls) {\n            b.destroy();\n        }\n        for (let b of this.smallBalls) {\n            b.destroy();\n        }\n        this.tmpBalls.splice(0);\n        this.smallBalls.splice(0);\n\n        for (let i = 0; i < data.small; i++) {\n            let ball = cc.instantiate(this.bulletNode);\n            ball.parent = this.ballPanel;\n            this.smallBalls.push(ball);\n            ball.getComponentInChildren(cc.Label).string = data.small - i;\n        }\n\n        this.bgNode.color = cc.color(\"#436770\");\n        this.loadBigBall(data.big);\n\n        this.scheduleOnce(() => {\n            this._gameStart = true;\n        }, 0.1);\n    },\n\n    start() {\n        let mng = cc.director.getCollisionManager();\n        mng.enabled = true;\n        // mng.enabledDebugDraw = true;\n        // mng.enabledDrawBoundingBox = true;\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        zy.event.on(\"gameover\", () => {\n            if (this._gameStart) {\n                this._gameStart = false;\n                this.bgNode.color = cc.color(\"#7A3341\");\n                zy.ui.tip.show(\"游戏失败，即将重新开始\");\n                this.scheduleOnce(() => {\n                    this.loadLevel(this.curLevel);\n                }, 2);\n            }\n        }, this);\n    },\n\n    loadBigBall(counts) {\n        this.bigBall.destroyAllChildren();\n        let radius = this.bigBall.width / 2 - 2;\n        let degree = 360 / counts;\n        for (let i = 0; i < counts; i++) {\n            let ball = cc.instantiate(this.smallBallPF);\n            let radian = cc.misc.degreesToRadians(i * degree);\n            let x = radius * Math.sin(radian);\n            let y = radius * Math.cos(radian);\n            ball.x = x;\n            ball.y = y;\n            ball.parent = this.bigBall;\n            // 计算旋转角度\n            ball.angle = 180 - i * degree;\n            ball.getChildByName(\"numLabel\").active = false;\n        }\n    },\n\n    onTouchStart(event) {\n        if (!this._gameStart) {\n            return;\n        }\n\n        if (this.smallBalls.length > 0) {\n            let bullet = this.smallBalls.shift();\n            let wordPos = bullet.parent.convertToWorldSpaceAR(bullet.getPosition());\n\n            let ball = cc.instantiate(this.smallBallPF);\n            ball.getComponentInChildren(cc.Label).string = bullet.getComponentInChildren(cc.Label).string;\n            ball.parent = this.bigBall.parent;\n            ball.position = this.bigBall.parent.convertToNodeSpaceAR(wordPos);\n            this.tmpBalls.push(ball);\n            bullet.destroy();\n\n            let radius = this.bigBall.height / 2 - 2;\n            let des = cc.v2(0, this.bigBall.y - radius);\n            ball.runAction(cc.sequence(cc.moveTo(0.1, des), cc.callFunc(() => {\n                this.tmpBalls.shift();\n                ball.parent = this.bigBall;\n                let angle = this.bigBall.angle;\n                angle = angle % 360 + 180;\n                let radian = cc.misc.degreesToRadians(angle);\n\n                let x = radius * Math.sin(radian);\n                let y = radius * Math.cos(radian);\n                ball.x = x;\n                ball.y = y;\n                ball.angle = 180 - angle;\n\n                this._checkPass();\n            })));\n        }\n    },\n\n    _checkPass() {\n        if (this.smallBalls.length == 0) {\n            this.bgNode.color = cc.color(\"#4C7043\");\n            let des = \"恭喜过关，即将进入下一关\";\n            const max = 20;\n            if (this.curLevel < max) {\n                this.curLevel += 1;\n            } else {\n                des = \"恭喜你通关了\";\n            }\n            zy.ui.tip.show(des);\n            this.scheduleOnce(() => {\n                this.loadLevel(this.curLevel);\n            }, 2);\n            cc.sys.localStorage.setItem(\"game_level\", this.curLevel);\n        }\n        \n    },\n\n    lateUpdate(dt) {\n        if (!this._gameStart) {\n            return;\n        }\n        this.bigBall.angle += this._bigDir * this._bigSpeed;\n    }\n});"]}